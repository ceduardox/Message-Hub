<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Ryztor Agent IA" />
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Ryztor Agent IA - Gestiona tus mensajes de WhatsApp Business con IA integrada" />
    <meta name="keywords" content="WhatsApp, Inbox, Business, Mensajes, IA, Chatbot, Ryztor" />
    
    <!-- Open Graph -->
    <meta property="og:title" content="Ryztor Agent IA" />
    <meta property="og:description" content="Gestiona tus mensajes de WhatsApp Business con IA integrada" />
    <meta property="og:image" content="/icon-512.png" />
    <meta property="og:type" content="website" />
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="apple-touch-icon" href="/icon-512.png" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <title>Ryztor Agent IA</title>
    
    <!-- OneSignal Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      #splash{position:fixed;inset:0;z-index:9999;background:#0f172a;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .3s}
      #splash.hide{opacity:0;pointer-events:none}
      #splash .logo{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#10b981,#06b6d4);display:flex;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(16,185,129,.4);animation:pulse-s 1.5s infinite}
      #splash .logo svg{width:28px;height:28px;color:#fff}
      #splash .title{margin-top:16px;font:700 20px Inter,sans-serif;color:#fff}
      #splash .title span{background:linear-gradient(90deg,#34d399,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
      @keyframes pulse-s{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    </style>
  </head>
  <body>
    <div id="splash">
      <div class="logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
      <div class="title">Ryztor Agent <span>IA</span></div>
    </div>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      // OneSignal initialization with full configuration
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      window.oneSignalReady = false;
      
      OneSignalDeferred.push(async function(OneSignal) {
        try {
          await OneSignal.init({
            appId: "07dfe1e4-83b1-4623-b57c-e6e33232d4eb",
            allowLocalhostAsSecureOrigin: true,
            serviceWorkerPath: "/OneSignalSDKWorker.js",
            serviceWorkerParam: { scope: "/" },
            notifyButton: {
              enable: false
            }
          });
          
          window.oneSignalReady = true;
          console.log("[OneSignal] SDK initialized successfully");
          
          // Check current status
          const permission = OneSignal.Notifications.permission;
          const subscribed = OneSignal.User.PushSubscription.optedIn;
          console.log("[OneSignal] Current status - Permission:", permission, "Subscribed:", subscribed);
          
        } catch (error) {
          console.error("[OneSignal] Init error:", error);
        }
      });
      
      // Expose function to manually trigger subscription
      window.subscribeToNotifications = async function() {
        console.log("[OneSignal] Subscribe called, ready:", window.oneSignalReady);
        
        if (!window.oneSignalReady) {
          return { success: false, reason: "OneSignal not ready yet" };
        }
        
        try {
          // First check if already subscribed
          const currentStatus = OneSignal.User.PushSubscription.optedIn;
          console.log("[OneSignal] Current optedIn:", currentStatus);
          
          if (currentStatus) {
            return { success: true, subscribed: true, message: "Already subscribed" };
          }
          
          // Request permission - this triggers the native browser popup
          console.log("[OneSignal] Requesting permission...");
          const granted = await OneSignal.Notifications.requestPermission();
          console.log("[OneSignal] Permission granted:", granted);
          
          if (granted) {
            // Opt in to push
            await OneSignal.User.PushSubscription.optIn();
            console.log("[OneSignal] Opted in successfully");
            return { success: true, subscribed: true };
          } else {
            return { success: false, reason: "Permission denied by user" };
          }
        } catch (error) {
          console.error("[OneSignal] Subscribe error:", error);
          return { success: false, reason: error.message || "Unknown error" };
        }
      };
      
      // Check subscription status
      window.getNotificationStatus = function() {
        if (!window.oneSignalReady) {
          return { ready: false, permission: false, subscribed: false };
        }
        return {
          ready: true,
          permission: OneSignal.Notifications.permission,
          subscribed: OneSignal.User.PushSubscription.optedIn
        };
      };
    </script>
  </body>
</html>
